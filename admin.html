<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Адмін панель - Пекарня в Ходосівці</title>
    <link rel="stylesheet" href="admin-styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="admin-container">
        <!-- Header -->
        <header class="admin-header">
            <div class="header-content">
                                    <div class="logo">
                        <img src="logo.jpg" alt="Пекарня" class="logo-img">
                        <h1>Адмін панель</h1>
                        <p style="font-size: 0.9rem; color: #8B7355; margin: 0;">Творець: @mm.slmn</p>
                        <p id="user-level" style="font-size: 0.8rem; color: #4D372C; margin: 0; font-weight: 500;"></p>
                    </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="previewSite()">
                        <i class="fas fa-eye"></i> Переглянути сайт
                    </button>
                    <button class="btn btn-primary" onclick="saveChanges()">
                        <i class="fas fa-save"></i> Зберегти
                    </button>
                    <button class="btn btn-secondary" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Вийти
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="admin-main">
            <!-- Navigation Tabs -->
            <div class="tabs">
                <button class="tab-btn active" data-tab="content">
                    <i class="fas fa-edit"></i> Контент
                </button>
                <button class="tab-btn" data-tab="menu">
                    <i class="fas fa-utensils"></i> Меню
                </button>
                <button class="tab-btn" data-tab="contact">
                    <i class="fas fa-phone"></i> Контакти
                </button>
                <button class="tab-btn" data-tab="settings">
                    <i class="fas fa-cog"></i> Налаштування
                </button>
                <button class="tab-btn" data-tab="admins">
                    <i class="fas fa-users-cog"></i> Адміністратори
                </button>
            </div>

            <!-- Content Tab -->
            <div class="tab-content active" id="content">
                <div class="section">
                    <h3>Головна сторінка</h3>
                    <div class="form-group">
                        <label>Заголовок</label>
                        <input type="text" id="hero-title" value="Свіжа випічка щодня" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Підзаголовок</label>
                        <textarea id="hero-subtitle" class="form-textarea">Натуральні інгредієнти та традиційні рецепти для найкращого смаку</textarea>
                    </div>
                </div>

                <div class="section">
                    <h3>Про нас</h3>
                    <div class="form-group">
                        <label>Опис</label>
                        <textarea id="about-text" class="form-textarea">Наша пекарня в Ходосівці - це місце, де традиції зустрічаються з якістю. Ми випікаємо свіжий хліб та кондитерські вироби щодня, використовуючи тільки натуральні інгредієнти.</textarea>
                    </div>
                </div>
            </div>

            <!-- Menu Tab -->
            <div class="tab-content" id="menu">
                <div class="section">
                    <h3>Управління категоріями</h3>
                    <button class="btn btn-primary" onclick="addCategory()">
                        <i class="fas fa-plus"></i> Додати категорію
                    </button>
                    
                    <div class="categories" id="categories">
                        <!-- Categories will be loaded here -->
                    </div>
                </div>
                
                <div class="section">
                    <h3>Управління продуктами</h3>
                    <button class="btn btn-primary" onclick="addMenuItem()">
                        <i class="fas fa-plus"></i> Додати продукт
                    </button>
                    
                    <div class="menu-items" id="menu-items">
                        <!-- Menu items will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Contact Tab -->
            <div class="tab-content" id="contact">
                <div class="section">
                    <h3>Контактна інформація</h3>
                    <div class="form-group">
                        <label>Телефон</label>
                        <input type="tel" id="phone" value="+380976492525" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Адреса</label>
                        <input type="text" id="address" value="вул. Феодосія Печерського, 1, Ходосівка, Київська область, 08173" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Години роботи</label>
                        <input type="text" id="hours" value="Щодня з 08:00 до 21:00" class="form-input">
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-content" id="settings">
                <div class="section">
                    <h3>Налаштування сайту</h3>
                    <div class="form-group">
                        <label>Назва сайту</label>
                        <input type="text" id="site-title" value="Пекарня в Ходосівці" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Колір теми</label>
                        <select id="theme-color" class="form-select">
                            <option value="brown">Коричневий</option>
                            <option value="beige">Бежевий</option>
                            <option value="cream">Кремовий</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Admins Tab -->
            <div class="tab-content" id="admins">
                <div class="section">
                    <h3>Управління адміністраторами</h3>
                    <p>Тут ви можете додавати та видаляти адміністраторів сайту.</p>
                    <button class="btn btn-primary" onclick="window.location.href='admin-users.html'">
                        <i class="fas fa-users-cog"></i> Управління адміністраторами
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal for adding categories -->
    <div class="modal" id="category-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Додати категорію</h3>
                <button class="close-btn" onclick="closeCategoryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Назва категорії</label>
                    <input type="text" id="category-name" class="form-input" placeholder="Наприклад: Хліб">
                </div>
                <div class="form-group">
                    <label>Опис категорії</label>
                    <textarea id="category-description" class="form-textarea" placeholder="Короткий опис категорії"></textarea>
                </div>
                <div class="form-group">
                    <label>Код категорії</label>
                    <input type="text" id="category-code" class="form-input" placeholder="Наприклад: bread">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCategoryModal()">Скасувати</button>
                <button class="btn btn-primary" onclick="saveCategory()">Зберегти</button>
            </div>
        </div>
    </div>

    <!-- Modal for adding menu items -->
    <div class="modal" id="menu-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Додати продукт</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Назва продукту</label>
                    <input type="text" id="item-name" class="form-input">
                </div>
                <div class="form-group">
                    <label>Опис</label>
                    <textarea id="item-description" class="form-textarea"></textarea>
                </div>
                <div class="form-group">
                    <label>Ціна (грн)</label>
                    <input type="number" id="item-price" class="form-input">
                </div>
                <div class="form-group">
                    <label>Категорія</label>
                    <select id="item-category" class="form-select">
                        <option value="">Виберіть категорію</option>
                        <!-- Categories will be loaded here -->
                    </select>
                </div>
                <div class="form-group">
                    <label>Зображення продукту</label>
                    <div class="image-upload-container">
                        <input type="file" id="item-image-file" class="form-input" accept="image/*" onchange="previewImage(this)">
                        <div class="image-preview" id="image-preview">
                            <p>Перетягніть фото сюди або натисніть для вибору</p>
                        </div>
                        <div class="image-options">
                            <label>
                                <input type="radio" name="image-source" value="url" checked onchange="toggleImageSource()"> URL зображення (рекомендується)
                            </label>
                            <label>
                                <input type="radio" name="image-source" value="file" onchange="toggleImageSource()"> Завантажити з пристрою
                            </label>
                        </div>
                        <input type="text" id="item-image-url" class="form-input" placeholder="https://images.unsplash.com/photo-1509440159596-0249088772ff?w=400&h=300&fit=crop">
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">
                            💡 Використовуйте посилання з <a href="https://unsplash.com/s/photos/bread" target="_blank">Unsplash</a>, 
                            <a href="https://www.pexels.com/search/bread/" target="_blank">Pexels</a> або 
                            <a href="https://imgur.com/" target="_blank">Imgur</a>
                        </p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Скасувати</button>
                <button class="btn btn-primary" onclick="saveMenuItem()">Зберегти</button>
            </div>
        </div>
    </div>

    <script src="admin.js"></script>
    <script>
                // Check authentication
        function checkAuth() {
            const isLoggedIn = localStorage.getItem('adminLoggedIn');
            const loginTime = localStorage.getItem('adminLoginTime');
            const currentTime = Date.now();

            // Check if logged in and session is valid (24 hours)
            if (!isLoggedIn || !loginTime || (currentTime - loginTime) > 24 * 60 * 60 * 1000) {
                // Clear invalid session
                localStorage.removeItem('adminLoggedIn');
                localStorage.removeItem('adminLoginTime');

                // Check if we're on init page
                if (window.location.pathname.includes('init-admin.html')) {
                    return true; // Allow access to init page
                }

                // Redirect to login
                window.location.href = 'admin-login.html';
                return false;
            }
            return true;
        }
        
        // Check auth on page load
        window.addEventListener('load', function() {
            if (!checkAuth()) {
                return;
            }
        });
        
        // Add logout function
        function logout() {
            localStorage.removeItem('adminLoggedIn');
            localStorage.removeItem('adminLoginTime');
            window.location.href = 'admin-login.html';
        }
        
        // Check admin permissions
        function checkAdminPermissions() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                window.location.href = 'admin-login.html';
                return;
            }
            
            const admins = JSON.parse(localStorage.getItem('admins') || '[]');
            const userAdmin = admins.find(a => a.phone === currentUser.phone);
            
            if (!userAdmin) {
                // If no admins exist, allow access to create first admin
                if (admins.length === 0) {
                    return;
                }
                
                alert('У вас немає прав доступу до адмін панелі');
                window.location.href = 'index.html';
                return;
            }
            
            // Hide admin management for moderators
            if (userAdmin.level === 'moderator') {
                const adminsTab = document.querySelector('[data-tab="admins"]');
                if (adminsTab) {
                    adminsTab.style.display = 'none';
                }
            }
        }
        
        // Display user level
        function displayUserLevel() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const userLevelElement = document.getElementById('user-level');
            
            if (currentUser && userLevelElement) {
                const admins = JSON.parse(localStorage.getItem('admins') || '[]');
                const userAdmin = admins.find(a => a.phone === currentUser.phone);
                
                if (userAdmin) {
                    let levelText = '';
                    let levelColor = '';
                    
                    switch(userAdmin.level) {
                        case 'owner':
                            levelText = '👑 Власник';
                            levelColor = '#FFD700';
                            break;
                        case 'admin':
                            levelText = '⚙️ Адміністратор';
                            levelColor = '#4CAF50';
                            break;
                        case 'moderator':
                            levelText = '🔧 Модератор';
                            levelColor = '#2196F3';
                            break;
                        default:
                            levelText = '👤 Користувач';
                            levelColor = '#9E9E9E';
                    }
                    
                    userLevelElement.textContent = `${currentUser.name} - ${levelText}`;
                    userLevelElement.style.color = levelColor;
                } else {
                    userLevelElement.textContent = `${currentUser.name} - 👤 Користувач`;
                    userLevelElement.style.color = '#9E9E9E';
                }
            }
        }
        
        // Category management functions
        function addCategory() {
            document.getElementById('category-modal').style.display = 'block';
        }
        
        function closeCategoryModal() {
            document.getElementById('category-modal').style.display = 'none';
            // Clear form
            document.getElementById('category-name').value = '';
            document.getElementById('category-description').value = '';
            document.getElementById('category-code').value = '';
        }
        
        function saveCategory() {
            const name = document.getElementById('category-name').value;
            const description = document.getElementById('category-description').value;
            const code = document.getElementById('category-code').value;
            
            if (!name || !code) {
                alert('Будь ласка, заповніть назву та код категорії');
                return;
            }
            
            const category = {
                id: Date.now(),
                name: name,
                description: description,
                code: code,
                createdAt: new Date().toISOString()
            };
            
            // Get existing categories
            const categories = JSON.parse(localStorage.getItem('categories') || '[]');
            categories.push(category);
            localStorage.setItem('categories', JSON.stringify(categories));
            
            closeCategoryModal();
            loadCategories();
            alert('Категорію додано!');
        }
        
        function loadCategories() {
            const categories = JSON.parse(localStorage.getItem('categories') || '[]');
            const container = document.getElementById('categories');
            
            if (categories.length === 0) {
                container.innerHTML = '<p>Поки що немає категорій</p>';
            } else {
                container.innerHTML = categories.map((category, index) => `
                    <div class="menu-item">
                        <div class="menu-item-header">
                            <div class="menu-item-title">
                                <i class="fas fa-tag"></i>
                                ${category.name}
                                <span class="category-code">(${category.code})</span>
                            </div>
                            <div class="menu-item-actions">
                                <button class="btn btn-secondary" onclick="editCategory(${index})">
                                    <i class="fas fa-edit"></i> Редагувати
                                </button>
                                <button class="btn btn-secondary" onclick="deleteCategory(${index})">
                                    <i class="fas fa-trash"></i> Видалити
                                </button>
                            </div>
                        </div>
                        <div class="menu-item-details">
                            ${category.description || 'Немає опису'}
                        </div>
                    </div>
                `).join('');
            }
            
            // Also update the category select in menu modal
            loadCategorySelect();
        }
        
        function loadCategorySelect() {
            const categories = JSON.parse(localStorage.getItem('categories') || '[]');
            const select = document.getElementById('item-category');
            
            if (select) {
                let options = '<option value="">Виберіть категорію</option>';
                categories.forEach(category => {
                    options += `<option value="${category.code}">${category.name}</option>`;
                });
                select.innerHTML = options;
            }
        }
        
        function deleteCategory(index) {
            if (confirm('Ви впевнені, що хочете видалити цю категорію?')) {
                const categories = JSON.parse(localStorage.getItem('categories') || '[]');
                categories.splice(index, 1);
                localStorage.setItem('categories', JSON.stringify(categories));
                loadCategories();
                alert('Категорію видалено!');
            }
        }
        
        function editCategory(index) {
            const categories = JSON.parse(localStorage.getItem('categories') || '[]');
            const category = categories[index];
            
            document.getElementById('category-name').value = category.name;
            document.getElementById('category-description').value = category.description || '';
            document.getElementById('category-code').value = category.code;
            
            // Change modal title and button
            document.querySelector('#category-modal .modal-header h3').textContent = 'Редагувати категорію';
            document.querySelector('#category-modal .modal-footer .btn-primary').onclick = function() {
                updateCategory(index);
            };
            
            document.getElementById('category-modal').style.display = 'block';
        }
        
        function updateCategory(index) {
            const name = document.getElementById('category-name').value;
            const description = document.getElementById('category-description').value;
            const code = document.getElementById('category-code').value;
            
            if (!name || !code) {
                alert('Будь ласка, заповніть назву та код категорії');
                return;
            }
            
            const categories = JSON.parse(localStorage.getItem('categories') || '[]');
            categories[index] = {
                ...categories[index],
                name: name,
                description: description,
                code: code,
                updatedAt: new Date().toISOString()
            };
            
            localStorage.setItem('categories', JSON.stringify(categories));
            closeCategoryModal();
            loadCategories();
            alert('Категорію оновлено!');
        }
        
        // Menu items management functions
        function addMenuItem() {
            document.getElementById('menu-modal').style.display = 'block';
            // Reset form
            document.getElementById('item-name').value = '';
            document.getElementById('item-description').value = '';
            document.getElementById('item-price').value = '';
            document.getElementById('item-category').value = '';
            document.getElementById('item-image').value = '';
            
            // Change modal title and button
            document.querySelector('#menu-modal .modal-header h3').textContent = 'Додати продукт';
            document.querySelector('#menu-modal .modal-footer .btn-primary').onclick = function() {
                saveMenuItem();
            };
        }
        
        function closeModal() {
            const modal = document.getElementById('menu-modal');
            if (modal) {
                modal.style.display = 'none';
                console.log('Modal closed');
            } else {
                console.error('Modal not found');
            }
        }
        
        function saveMenuItem() {
            console.log('saveMenuItem called');
            
            const name = document.getElementById('item-name').value;
            const description = document.getElementById('item-description').value;
            const price = document.getElementById('item-price').value;
            const category = document.getElementById('item-category').value;
            
            // Get image from URL field or use default
            const imageUrl = document.getElementById('item-image-url').value;
            const imageFile = document.getElementById('item-image-file').files[0];
            
            console.log('Form values:', { name, description, price, category, imageUrl, imageFile });
            
            if (!name || !price || !category) {
                alert('Будь ласка, заповніть назву, ціну та категорію продукту');
                return;
            }
            
            // Determine image source
            let image = 'https://images.unsplash.com/photo-1509440159596-0249088772ff?w=400&h=300&fit=crop'; // Default bread image
            if (imageUrl && imageUrl.trim()) {
                image = imageUrl.trim();
            } else if (imageFile) {
                // Convert file to base64 (not recommended for large files)
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64Image = e.target.result;
                    const menuItem = {
                        id: Date.now(),
                        name: name,
                        description: description,
                        price: price + ' грн',
                        category: category,
                        image: base64Image,
                        createdAt: new Date().toISOString()
                    };
                    
                    const menuItems = JSON.parse(localStorage.getItem('menuItems') || '[]');
                    menuItems.push(menuItem);
                    localStorage.setItem('menuItems', JSON.stringify(menuItems));
                    
                    closeModal();
                    loadMenuItems();
                    alert('Продукт додано! Зображення збережено як Base64 (може бути повільним).');
                };
                reader.readAsDataURL(imageFile);
                return; // Exit early as we're handling the file asynchronously
            }
            
            const menuItem = {
                id: Date.now(),
                name: name,
                description: description,
                price: price + ' грн',
                category: category,
                image: image,
                createdAt: new Date().toISOString()
            };
            
            console.log('Created menu item:', menuItem);
            
            // Get existing menu items
            const menuItems = JSON.parse(localStorage.getItem('menuItems') || '[]');
            menuItems.push(menuItem);
            
            console.log('All menu items:', menuItems);
            
            localStorage.setItem('menuItems', JSON.stringify(menuItems));
            
            console.log('Product saved to localStorage');
            
            closeModal();
            loadMenuItems();
            alert('Продукт додано! Тепер він з\'явиться на головній сторінці.');
        }
        
        function loadMenuItems() {
            console.log('loadMenuItems called');
            
            const menuItems = JSON.parse(localStorage.getItem('menuItems') || '[]');
            const container = document.getElementById('menu-items');
            
            console.log('Found menu items:', menuItems);
            console.log('Container:', container);
            
            if (!container) {
                console.error('Container menu-items not found!');
                return;
            }
            
            if (menuItems.length === 0) {
                container.innerHTML = '<p>Поки що немає продуктів</p>';
                console.log('No products to display');
                return;
            }
            
            const html = menuItems.map((item, index) => `
                <div class="menu-item">
                    <div class="menu-item-header">
                        <div class="menu-item-title">
                            <i class="fas fa-utensils"></i>
                            ${item.name}
                            <span class="price">${item.price}</span>
                        </div>
                        <div class="menu-item-actions">
                            <button class="btn btn-secondary" onclick="editMenuItem(${index})">
                                <i class="fas fa-edit"></i> Редагувати
                            </button>
                            <button class="btn btn-secondary" onclick="deleteMenuItem(${index})">
                                <i class="fas fa-trash"></i> Видалити
                            </button>
                        </div>
                    </div>
                    <div class="menu-item-details">
                        <p><strong>Опис:</strong> ${item.description || 'Немає опису'}</p>
                        <p><strong>Категорія:</strong> ${item.category}</p>
                        <p><strong>Зображення:</strong> ${item.image}</p>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
            console.log('Products loaded successfully');
        }
        
        function deleteMenuItem(index) {
            if (confirm('Ви впевнені, що хочете видалити цей продукт?')) {
                const menuItems = JSON.parse(localStorage.getItem('menuItems') || '[]');
                menuItems.splice(index, 1);
                localStorage.setItem('menuItems', JSON.stringify(menuItems));
                loadMenuItems();
                alert('Продукт видалено!');
            }
        }
        
        function editMenuItem(index) {
            const menuItems = JSON.parse(localStorage.getItem('menuItems') || '[]');
            const item = menuItems[index];
            
            document.getElementById('item-name').value = item.name;
            document.getElementById('item-description').value = item.description || '';
            document.getElementById('item-price').value = item.price.replace(' грн', '');
            document.getElementById('item-category').value = item.category;
            document.getElementById('item-image-url').value = item.image;
            
            // Change modal title and button
            document.querySelector('#menu-modal .modal-header h3').textContent = 'Редагувати продукт';
            document.querySelector('#menu-modal .modal-footer .btn-primary').onclick = function() {
                updateMenuItem(index);
            };
            
            document.getElementById('menu-modal').style.display = 'block';
        }
        
        function updateMenuItem(index) {
            const name = document.getElementById('item-name').value;
            const description = document.getElementById('item-description').value;
            const price = document.getElementById('item-price').value;
            const category = document.getElementById('item-category').value;
            
            // Get image from URL field or use default
            const imageUrl = document.getElementById('item-image-url').value;
            const imageFile = document.getElementById('item-image-file').files[0];
            
            if (!name || !price || !category) {
                alert('Будь ласка, заповніть назву, ціну та категорію продукту');
                return;
            }
            
            // Determine image source
            let image = 'default-food.jpg';
            if (imageUrl) {
                image = imageUrl;
            } else if (imageFile) {
                // For now, just use the filename
                image = imageFile.name;
            }
            
            const menuItems = JSON.parse(localStorage.getItem('menuItems') || '[]');
            menuItems[index] = {
                ...menuItems[index],
                name: name,
                description: description,
                price: price + ' грн',
                category: category,
                image: image,
                updatedAt: new Date().toISOString()
            };
            
            localStorage.setItem('menuItems', JSON.stringify(menuItems));
            closeModal();
            loadMenuItems();
            alert('Продукт оновлено! Зміни з\'являться на головній сторінці.');
        }
        
        // Image preview function
        function previewImage(input) {
            const file = input.files[0];
            const preview = document.getElementById('image-preview');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" style="max-width: 200px; max-height: 200px;">`;
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Toggle image source
        function toggleImageSource() {
            const fileInput = document.getElementById('item-image-file');
            const urlInput = document.getElementById('item-image-url');
            const fileRadio = document.querySelector('input[name="image-source"][value="file"]');
            const urlRadio = document.querySelector('input[name="image-source"][value="url"]');
            
            if (urlRadio.checked) {
                fileInput.style.display = 'none';
                urlInput.style.display = 'block';
            } else {
                fileInput.style.display = 'block';
                urlInput.style.display = 'none';
            }
        }
        
        // Check permissions on page load
        window.addEventListener('load', function() {
            if (!checkAuth()) {
                return;
            }
            checkAdminPermissions();
            displayUserLevel();
            loadCategories(); // Load categories on page load
            loadMenuItems(); // Load menu items on page load
        });
    </script>
</body>
</html> 